<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>从 Model 开始：创建第一个模型类 &mdash; Practical Django 1.3 文档</title>
    
    <link rel="stylesheet" href="../_static/flasky.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <link rel="top" title="Practical Django 1.3 文档" href="../index.html" />
    <link rel="next" title="Model 之外：Django 也可以有 scaffold" href="../3 Model之外/3.1 Django也可以有scaffold.html" />
    <link rel="prev" title="实战系列的开发目标：需求分析和设计" href="../1 实战系列的开发目标/1.1 需求分析和设计.html" /> 
  </head>
  <body role="document">
  
  


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="model">
<h1>从 Model 开始：创建第一个模型类<a class="headerlink" href="#model" title="永久链接至标题">¶</a></h1>
<p>从模型开始开发似乎是个好主意。一方面模型是整个应用的核心，实现了应用的业务数据和对业务数据进行操作的约束，而视图和模板只是向用户提供操作和展现这些数据的界面；另一方面模型相对于系统的其他部分更加稳定，将模型先确定下来有助于系统其他部分的实现。DDD（领域驱动设计）更进一步将模型中的核心对象抽取出来作为“领域模型”。</p>
<p>从 Depot 应用来看，产品（Product) 应该是模型中的核心对象之一。就让我们先来实现 Product 模型。</p>
<div class="section" id="app">
<h2>创建 app<a class="headerlink" href="#app" title="永久链接至标题">¶</a></h2>
<p>我们可以从 <a class="reference internal" href="../0 预备知识/0.2 Django第一步.html#django"><span>预备知识：Django 第一步</span></a> 中实现的工程开始。在继续之前，还要进行一些准备工作。</p>
<p>Django 约定必须要创建 app 才能使用模型。这也是 Django 的哲学之一：Django 认为一个 project 包含很多个 Django app；project 提供配置文件，比如数据库连接信息、安装的 app 清单、模板路径等等；而一个 app 是一套 Django 功能的集合，通常包括模型和视图，按 Python 的包结构的方式存在。app 可以在多个 project 之间很容易的复用。比如 Django 自带的注释系统和自动管理界面。</p>
<p>所以我们在原有工程的基础上还需要创建一个 app 。现在假设我们只需要一个 app ，并将其命名为 depotapp 。创建应用的脚本也是使用 project 目录下的 <cite>manage.py</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ python manage.py startapp depotapp
</pre></div>
</div>
<p>就会在工程目录下创建一个 depotapp 目录：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>depotapp/
    __init__.py
    models.py
    tests.py
    views.py
</pre></div>
</div>
</div>
<div class="section" id="python">
<h2>用 Python 代码定义数据库<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h2>
<p>在 <a class="reference internal" href="../0 预备知识/0.0 Django第一印象.html#django"><span>预备知识：Django 第一印象</span></a> 中介绍过，Django 的设计是以 Python 类的形式定义数据模型。之所以没有采用 Rails 的运行时自动获取数据库 schema 的“魔术方式”，是出于以下的考虑：</p>
<ol class="arabic simple">
<li>效率。运行时扫描数据库可能会带来性能问题。</li>
<li>明确性。只通过 Model 类就完全知道数据库中有哪些字段，而不需要再切换到 migration 或 schema 文件中去查看，更不需要去查看数据库结构。</li>
<li>一致性。你看到的只是 Python 代码，完全不需要将大脑切换到“数据库模式”，能极大提高开发效率。</li>
<li>版本控制。Rails 中的数据库结构版本保存在一个个的 migration 文件中，这简直就是版本管理的“反模式”。Django 的方式是管理 Model 代码文件的版本。</li>
<li>可扩展性。可以定义数据库中不存在的“字段类型”。比如 Email，URL 等等。</li>
</ol>
<p>当然，Django 也提供从现有数据库表中自动扫描生成模型的工具。</p>
<p>so，《Agile Web Development with Rails》中的做法是先创建数据库表：</p>
<div class="highlight-sql"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">products</span><span class="p">;</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">products</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">int</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span><span class="p">,</span>
    <span class="n">title</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">description</span> <span class="nb">text</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">image_url</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="n">price</span> <span class="nb">decimal</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
    <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<p>然后再生成 scaffold（包括 model、controller、test、4个views等等）。</p>
<p>而Django的做法是，编写下面的Model类：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># depot/depotapp/models.py:</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">image_url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span><span class="n">decimal_places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>如同其他的 ORM，ID 字段是默认声明的，不需要单独处理.</p>
</div>
<div class="section" id="id1">
<h2>部署模型<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h2>
<p>Django 中的每一件事情都需要明确声明，也就是说，没有你的允许，Django 不会主动去碰你的代码。所以我们还需要在 project 中进行一些配置工作才能让 app 生效。不过这样的配置只需要做一次。</p>
<p>首先要创建数据库并配置整个 project 的数据库连接，为了简单起见，使用 sqlite 数据库。在工程文件夹下创建 db 文件夹和 sqlite 数据库文件：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ mkdir db
$ cd db
$ sqlite3 development.sqlite3
</pre></div>
</div>
<p>然后修改配置文件 <cite>settings.py</cite>, 将 DATABASES 改为：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;db/development.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>就完成了数据库的配置。</p>
<p>还需要配置 project 让 depotapp 生效，还是在 <cite>settings.py</cite> 中，将 INSTALLED_APPS 改为：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="c1">#&#39;django.contrib.auth&#39;,</span>
    <span class="c1">#&#39;django.contrib.contenttypes&#39;,</span>
    <span class="c1">#&#39;django.contrib.sessions&#39;,</span>
    <span class="c1">#&#39;django.contrib.sites&#39;,</span>
    <span class="c1">#&#39;django.contrib.messages&#39;,</span>
    <span class="c1">#&#39;django.contrib.staticfiles&#39;,</span>
    <span class="c1"># Uncomment the next line to enable the admin:</span>
    <span class="c1"># &#39;django.contrib.admin&#39;,</span>
    <span class="c1"># Uncomment the next line to enable admin documentation:</span>
    <span class="c1"># &#39;django.contrib.admindocs&#39;,</span>
    <span class="s1">&#39;depotapp&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>接下来就可以使用模型了。先验证一下：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ python manage.py validate
0 errors found
</pre></div>
</div>
<p>然后可以看一下这个 Model 将会生成什么样的数据库：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ python manage.py sqlall depotapp
BEGIN;
CREATE TABLE &quot;depotapp_product&quot; (
    &quot;id&quot; integer NOT NULL PRIMARY KEY,
    &quot;title&quot; varchar(100) NOT NULL,
    &quot;description&quot; text NOT NULL,
    &quot;image_url&quot; varchar(200) NOT NULL,
    &quot;price&quot; decimal NOT NULL
)
;
COMMIT;
</pre></div>
</div>
<p>最后，将模型导入数据库：</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$ python manage.py syncdb
Creating tables ...
Creating table depotapp_product
Installing custom SQL ...
Installing indexes ...
No fixtures found.
</pre></div>
</div>
<p>至此，完成了第一个模型类的创建。</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <a href="http://github.com/xuehao/Practical_Django"><img style="position: fixed; top: 0; right: 0; border: 0;"
    src="http://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub" /></a>
  

  

  </body>
</html>